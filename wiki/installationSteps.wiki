#summary Step-by-step overview of the installation

= Prerequisites =
You will need working versions of
  * Linux
  * Syslog-NG >= 3.1
  * MySQL >= 5.0
  * Sphinx >= 0.9.9
  * Recent DBD::mysql (installed below)

=Installation Steps for Web Frontend=
{{{
# Download ELSA
wget "http://code.google.com/p/enterprise-log-search-and-archive/downloads/elsa.tar.gz"

# Create base directories
cd /usr/local && sudo tar xzvf elsa.tar.gz

# Create database.  This will vary depending on where your MySQL DB will be for the query info (not raw logs).
sudo mysqladmin create elsa_web &&
mysql -uroot -e 'GRANT ALL ON elsa_web.* TO "elsa"@"%" IDENTIFIED BY "biglog"' &&
sudo mysql elsa_web -e "source /usr/local/elsa/web/conf/meta_db_schema.sql"

# Copy conf to /etc/
cp /usr/local/elsa/web/conf/elsa.conf /etc/elsa_web.conf

# Edit config and set meta_db info, set auth method, node connect info

# Install required Perl modules
sudo cpan
o conf prerequisites_policy follow
o conf commit
install App::cpanminus
quit

# Now cpanm is available to install the rest
sudo cpanm Moose Config::JSON Plack::Builder Plack::App::File Date::Manip Digest::SHA1 MIME::Base64 URI::Escape Socket Net::DNS Sys::Hostname::FQDN String::CRC32 CHI CHI::Driver::RawMemory Search::QueryParser AnyEvent::DBI EV Sys::Info Sys::MemInfo MooseX::Traits Authen::Simple Authen::Simple::PAM Plack::Middleware::CrossOrigin URI::Escape Module::Pluggable Module::Install PDF::API2::Simple XML::Writer Parse::Snort Spreadsheet::WriteExcel IO::String Mail::Internet Plack::Middleware::Static

# Start the test web server to verify everything works
cd /usr/local/elsa/web/lib &&
ELSA_CONF=/etc/elsa_web.conf plackup Web.psgi

# Try to connect on http://<web server ip>:5000

# If all goes well, you can choose to either run permanently under a standalone Perl web server or under Apache.  The choice usually comes down to whether you are hosting other web sites alongside ELSA on this web node.

# For standalone, install starman (production-grade version of plackup):
sudo cpanm starman

# Run starman just like plackup above

# For Apache, locations vary, but this is the gist:
cp /usr/local/elsa/web/conf/apache_site.conf /etc/apache2/sites-available/elsa.conf
# Edit /etc/apache2/sites-available/elsa.conf appropriately for locations if you're using something non-default
# Install the Apache2 handler:
sudo cpanm Plack::Handler::Apache2
# Enable the site
ln -s /etc/apache2/sites-available/elsa.conf /etc/apache2/sites-enabled/elsa.conf
sudo restart apache2

# Setup alerts (optional)
# Edit /etc/elsa_web.conf and set the "smtp_server" and "to" fields under "email"
sudo crontab -e
* * * * * perl /usr/local/elsa/web/cron.pl -c /etc/elsa_web.conf 2>&1 > /dev/null

}}}

= Installation Steps For Log Nodes =
{{{
# Install required packages
sudo apt-get install subversion gcc g++ mysql-server libmysqlclient-dev

# Get the latest code from Google Code
cd /usr/local
sudo svn export "https://enterprise-log-search-and-archive.googlecode.com/svn/trunk/elsa"
sudo mkdir /usr/local/elsa/node/tmp && 
sudo mkdir /usr/local/elsa/node/tmp/locks && 
sudo touch /usr/local/elsa/node/tmp/locks/directory

# Install required Perl modules
sudo cpan
o conf prerequisites_policy follow
o conf commit
install App::cpanminus
quit

# Now cpanm is available to install the rest
sudo cpanm Config::JSON String::CRC32 Log::Log4perl DBD::mysql 

# Get and build sphinx on nodes
cd /tmp
sudo svn export "https://sphinxsearch.googlecode.com/svn/trunk/" sphinx-svn
cd sphinx-svn
./configure --enable-id64 --prefix=/usr/local/sphinx && make && sudo make install

# For Syslog-NG You have two choices, build from source, or install from .deb file:
# For the .deb file:
# Edit the sources file to get syslog-ng
echo "deb      http://packages.madhouse-project.org/ubuntu lucid syslog-ng" >> /etc/apt/sources.list
# Install syslog-ng 3.3 from packages
sudo apt-get install syslog-ng
# Copy the syslog-ng.conf
cp /usr/local/elsa/node/conf/syslog-ng.conf /etc/syslog-ng/conf.d/elsa.conf

# To build from source:
# Get and build syslog-ng
cd /tmp
wget "http://www.balabit.com/downloads/files/syslog-ng/open-source-edition/3.2.4/source/eventlog_0.2.12.tar.gz" &&
tar xzvf eventlog_0.2.12.tar.gz &&
cd eventlog-0.2.12 &&
./configure && make && sudo make install &&
cd /tmp &&
wget "http://www.balabit.com/downloads/files/syslog-ng/open-source-edition/3.2.4/source/syslog-ng_3.2.4.tar.gz" &&
tar xzvf syslog-ng_3.2.4.tar.gz &&
cd syslog-ng-3.2.4 &&
./configure --prefix=/usr/local/syslog-ng-3.2.4 --enable-ipv6 && 
make && sudo make install && 
sudo ln -s /usr/local/syslog-ng-3.2.4 /usr/local/syslog-ng
# Copy the syslog-ng.conf
cp /usr/local/elsa/node/conf/syslog-ng.conf /usr/local/syslog-ng/etc/syslog-ng/conf.d/elsa.conf

# Make data directories on node
sudo mkdir /data && sudo mkdir /data/elsa && sudo mkdir /data/elsa/log && 
sudo mkdir /data/elsa/tmp && sudo mkdir /data/elsa/tmp/buffers
sudo mkdir /data/sphinx && sudo mkdir /data/sphinx/log

# Install mysql schema
mysqladmin -uroot create syslog && mysqladmin -uroot create syslog_data && 
mysql -uroot -e 'GRANT ALL ON syslog.* TO "elsa"@"%" IDENTIFIED BY "biglog"' &&
mysql -uroot -e 'GRANT ALL ON syslog_data.* TO "elsa"@"%" IDENTIFIED BY "biglog"' && 
mysql -uelsa -pbiglog syslog -e "source /usr/local/elsa/node/conf/schema.sql"

# Copy elsa.conf to /etc/
sudo cp /usr/local/elsa/node/conf/elsa.conf /etc/elsa_node.conf

# Edit the elsa_node.conf for any customizations
# Edit database and make user/pass match the web node install above
# Edit log_size_limit to be maximum space you'll allow for logs
# The other settings should be fine if you're using the dirs referred to in this doc.

# Run elsa.pl for initial creation of sphinx config
echo "" | perl /usr/local/elsa/node/elsa.pl -on -c /etc/elsa_node.conf

# Initialize empty sphinx indexes
/usr/local/sphinx/bin/indexer --config /usr/local/etc/sphinx.conf --rotate --all
# Start sphinx
/usr/local/sphinx/bin/searchd --config /usr/local/etc/sphinx.conf --iostats --cpustats

# Start syslog-ng using the ELSA config
/usr/local/syslog-ng/sbin/syslog-ng -f /usr/local/elsa/node/conf/syslog-ng.conf

# Watch the log file to make sure it's working (after wiping indexes you should see batches processed and rows indexed)
tail -f /data/elsa/log/node.log
}}}